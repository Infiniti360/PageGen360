(()=>{"use strict";console.log("Background script loaded"),chrome.runtime.onMessage.addListener((e,o,r)=>{if(console.log("Background: Message received:",e),console.log("Background: Sender:",o),"SCAN_PAGE"===e.type)return console.log("Background: Getting active tab..."),chrome.tabs.query({active:!0,currentWindow:!0},e=>{if(0===e.length)return console.log("Background: No active tab found"),void r({error:"No active tab found"});const o=e[0];if(console.log("Background: Active tab found:",o),!o.id)return console.log("Background: No tab ID found"),void r({error:"No tab ID found"});const n=o.id;try{console.log("Background: Trying to send message to existing content script..."),chrome.tabs.sendMessage(n,{type:"SCAN_DOM"},e=>{chrome.runtime.lastError?(console.log("Background: No existing content script, injecting new one..."),chrome.scripting.executeScript({target:{tabId:n},files:["content-script.js"]},()=>{console.log("Background: Content script injected, now sending message..."),setTimeout(()=>{chrome.tabs.sendMessage(n,{type:"SCAN_DOM"},e=>{console.log("Background: Content script response received:",e),chrome.runtime.lastError?(console.error("Background: Chrome runtime error:",chrome.runtime.lastError),r({error:chrome.runtime.lastError.message})):(console.log("Background: Sending response to popup:",e),r(e))})},100)})):(console.log("Background: Content script response received:",e),r(e))})}catch(e){console.error("Background: Error sending message to content script:",e),r({error:e.message})}}),!0;console.log("Background: Invalid message type"),console.log("Background: Message type:",e.type),r(null)})})();